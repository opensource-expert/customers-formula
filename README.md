# higher level customers details

This customers formula for salt is designed to produce derived pillar configuration files.
It is currently generating pillar files on the saltmaster. 

It is a proof of concept and could be achieved with `ext_pillar`.

Context: customers for a web agency are defined at higher level in `pillar/customers.sls`
See: `pillar.example`

The `init.sls` state is producing pillar for other formulas:

* apache-formula
* mysql-formula
* users-formula

**Lecteurs francophones:** n'hésitez pas à demander une traduction si nécessaire, je la produirai.

## Source customers pillar

It looks like:

~~~yaml
wsf:
  global:
    webmaster: someone@webmaster.com
  customers:
    client1:
      domain_name: client1-domain.fr
      webmaster: client1@webmaster.com
      enabled: true
      delete: false
      # service to configure for this customer
      services:
        - webhost
        - dns
        - mysql
        - sftp
    # client2 as more default values
    client2:
      domain_name: more-domain.com
      enabled: true
      delete: false
      services:
        - webhost
        - dns
    client3:
      domain_name: somedomain.fr
      enabled: true
      # default, delete: false
      services:
        - webhost
        - dns
        - db
        - sftp
~~~

## Produced mysql-formula pillar

For this pillar we expect to generate users for having access to mariaDB.

Here's a *representation* of the merged output of `pillar/auto/mysql_db.sls` + `pillar/auto/mysql_users.sls`
Password management won't work that way, but it is just for description here. This pillar
is on the format expected by [mysql-formula](https://github.com/saltstack-formulas/mysql-formula).


~~~yaml
mysql:
  # Managed databases for customers
  # those databases are generated by the state/customers/init.sls
  database:
    - client1
    - client2
    - client3
  # merged…
  # Managed mariaDB users for customers
  # those mariaDB users are generated by the state/customers/init.sls
  # passwords are handled externally by a custom python script.
  user:
    client1:
      password: "{{ pass['client1']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client1
          grants: ['all privileges']
    client2:
      password: "{{ pass['client2']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client2
          grants: ['all privileges']
    client3:
      password: "{{ pass['client3']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client3
          grants: ['all privileges']
~~~

## install this state generator

### `pillar/top.sls`

~~~yaml
# vim: set ft=yaml:
#
# Pillar top inclusions
base:
  '*':
    # top level definition for customers avail to all rules
    - customers
  'db*':
    # pillar are merged
    # mysql.defaults it local site common usage of mysql-formula config…
    - mysql.defaults
    - auto.mysql_db
    - auto.mysql_users
~~~

### `state`

Put `state/customers.sls` in your `file_roots:`, edit in to fix paths:

* `pillar_dir` [line 23](/use_case/state/customers/init.sls#L23)
* `target_dir` [line 24](/use_case/state/customers/init.sls#L24)

run on the master (with care ;) )
* vim-formula

~~~bash
salt-call state.apply customers
~~~

This should create the auto/ folder and files inside, which can be propagated that way.

~~~bash
salt '*' saltutil.refresh_pillar
~~~

More details in [`customers/init.sls`](/use_case/state/customers/init.sls#L8)
